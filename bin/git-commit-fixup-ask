#!/usr/bin/env bash

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
source "${SCRIPT_DIR}/lib/common.sh"

#
# Usage
#

usage() {
    cat <<EOF
Usage: git commit-fixup-ask

Interactively create a fixup commit for staged changes.
Shows commits in the current branch and lets you pick which one to fixup.
Only works when you have staged changes ready to commit.

The command will:
  1. Show all commits in current branch (excluding fixup/squash commits)
  2. Show which staged files would be affected
  3. Let you choose which commit to create a fixup for

Examples:
  git add file.txt
  git commit-fixup-ask

Options:
  -h, --help    Show this help message
EOF
    exit 0
}

#
# Staged changes check
#

require_staged_changes() {
    if git diff --cached --quiet --exit-code; then
        die "Nothing to commit"
    fi
}

#
# Commit display
#

is_fixup_or_squash_commit() {
    local message="$1"
    [[ "${message:0:7}" == "fixup! " ]] || [[ "${message:0:8}" == "squash! " ]]
}

display_commit_with_stats() {
    local commit_id="$1"
    local index="$2"

    # Show commit info
    git --no-pager log \
        --pretty="format:${index}.  %Cred%h%Creset %s %Cgreen(%cr) %C(bold blue)<%an>%Creset" \
        --date=relative \
        -n1 "$commit_id"
    echo

    # Show which staged files are affected by this commit
    local staged_files
    staged_files=$(git --no-pager diff --cached --name-only)

    for filename in $staged_files; do
        # Temporarily disable pipefail for this pipeline
        set +o pipefail
        git --no-pager diff --stat=160 --color "$commit_id" "${commit_id}^" -- "$filename" 2>/dev/null | head -n 1
        set -o pipefail
    done
}

get_commits_for_branch() {
    local main_branch="$1"
    git --no-pager log --format=%H "${main_branch}...HEAD"
}

#
# User input
#

prompt_for_commit() {
    local max_index="$1"

    echo >&2
    read -p "Pick a commit [0..${max_index}]: " target_commit

    if ! is_integer "$target_commit"; then
        die "Expected a number in range [0..${max_index}]"
    fi

    if ! is_in_range "$target_commit" 0 "$max_index"; then
        die "Expected a number in range [0..${max_index}]"
    fi

    echo "$target_commit"
}

#
# Main
#

main() {
    # Handle help flag
    if [[ "${1:-}" == "-h" ]] || [[ "${1:-}" == "--help" ]]; then
        usage
    fi

    require_git_repo
    require_staged_changes

    local main_branch
    main_branch=$(get_main_branch)

    local relative_to_head=0
    local found_commits=false

    while IFS= read -r commit_id; do
        local commit_message
        commit_message=$(git --no-pager log --format=%B -n 1 "$commit_id")

        if is_fixup_or_squash_commit "$commit_message"; then
            ((relative_to_head++)) || true
            continue
        fi

        display_commit_with_stats "$commit_id" "$relative_to_head"
        ((relative_to_head++)) || true
        found_commits=true
    done < <(get_commits_for_branch "$main_branch")

    if [[ "$found_commits" == "false" ]]; then
        die "No commits in branch found using ${main_branch}...HEAD range"
    fi

    ((relative_to_head--))

    local target
    target=$(prompt_for_commit "$relative_to_head")

    git commit --fixup "HEAD~$target"
}

main "$@"
