#!/usr/bin/env bash

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
source "${SCRIPT_DIR}/lib/common.sh"

#
# Configuration
#

declare -A TOOL_EMAILS=(
    ["cursor"]="Cursor <cursor@cursor.sh>"
    ["copilot"]="GitHub Copilot <copilot@github.com>"
    ["factory"]="factory-droid[bot] <factory-droid[bot]@users.noreply.github.com>"
    ["devin"]="Devin <devin@cognition-labs.com>"
    ["jetbrains"]="JetBrains AI <ai@jetbrains.com>"
    ["claude"]="Claude <noreply@anthropic.com>"
)

#
# Usage
#

usage() {
    cat <<EOF
Usage: git aiu [--mode MODE] [--tool TOOL]

Track AI usage in commits by managing author and Co-authored-by metadata.
If options are not provided, the script will prompt interactively.

Options:
  --mode MODE   Specify the AI usage mode:
                  ai-authored  - AI wrote the code, human reviewed
                  ai-assisted  - Human wrote with AI assistance
                  organic      - No AI involvement

  --tool TOOL   Specify the AI tool used:
                  cursor       - Cursor
                  copilot      - GitHub Copilot
                  factory      - Factory AI
                  devin        - Devin
                  jetbrains    - JetBrains AI
                  claude       - Claude

  -h, --help    Show this help message

Modes:
  ai-authored:  Sets the AI tool as commit author, adds user as Co-authored-by
  ai-assisted:  Sets user as commit author, adds AI tool as Co-authored-by
  organic:      Sets user as commit author, removes AI tool from Co-authored-by

Examples:
  git aiu --mode ai-assisted --tool cursor
  git aiu
EOF
    exit 0
}

#
# Argument parsing
#

parse_args() {
    MODE=""
    TOOL=""

    while [[ $# -gt 0 ]]; do
        case "$1" in
            -h|--help)
                usage
                ;;
            --mode)
                MODE="$2"
                shift 2
                ;;
            --tool)
                TOOL="$2"
                shift 2
                ;;
            *)
                die "Unknown option $1"
                ;;
        esac
    done
}

#
# Interactive prompts
#

prompt_mode() {
    echo "Select AI usage mode:"
    echo "1. ai-authored  - AI wrote the code, human reviewed"
    echo "2. ai-assisted  - Human wrote with AI assistance"
    echo "3. organic      - No AI involvement"
    echo ""
    read -p "Pick a mode [1..3]: " mode_choice

    case "$mode_choice" in
        1) MODE="ai-authored" ;;
        2) MODE="ai-assisted" ;;
        3) MODE="organic" ;;
        *) die "Invalid choice. Expected 1, 2, or 3." ;;
    esac
}

prompt_tool() {
    echo ""
    echo "Select AI tool:"
    echo "1. cursor       - Cursor"
    echo "2. copilot      - GitHub Copilot"
    echo "3. factory      - Factory AI"
    echo "4. devin        - Devin"
    echo "5. jetbrains    - JetBrains AI"
    echo "6. claude       - Claude"
    echo ""
    read -p "Pick a tool [1..6]: " tool_choice

    case "$tool_choice" in
        1) TOOL="cursor" ;;
        2) TOOL="copilot" ;;
        3) TOOL="factory" ;;
        4) TOOL="devin" ;;
        5) TOOL="jetbrains" ;;
        6) TOOL="claude" ;;
        *) die "Invalid choice. Expected 1-6." ;;
    esac
}

#
# Validation
#

validate_mode() {
    if [[ "$MODE" != "ai-authored" && "$MODE" != "ai-assisted" && "$MODE" != "organic" ]]; then
        die "Invalid mode '$MODE'. Must be ai-authored, ai-assisted, or organic."
    fi
}

validate_tool() {
    if [[ -z "${TOOL_EMAILS[$TOOL]:-}" ]]; then
        die "Invalid tool '$TOOL'. Must be one of: cursor, copilot, factory, devin, jetbrains, claude."
    fi
}

#
# Co-author management
#

# Check if a line is a known AI tool Co-authored-by line
is_ai_coauthor_line() {
    local line="$1"
    for tool_email in "${TOOL_EMAILS[@]}"; do
        if [[ "$line" == "Co-authored-by: $tool_email" ]]; then
            return 0
        fi
    done
    return 1
}

# Remove AI tool Co-authored-by lines from commit message
remove_ai_coauthor() {
    local msg="$1"
    local result=""

    while IFS= read -r line; do
        if is_ai_coauthor_line "$line"; then
            continue
        fi
        if [[ -n "$result" ]]; then
            result="$result"$'\n'
        fi
        result="$result$line"
    done <<< "$msg"

    # Remove trailing empty lines
    echo "$result" | sed -e :a -e '/^\n*$/{$d;N;ba' -e '}'
}

# Add or replace Co-authored-by line
update_coauthor() {
    local msg="$1"
    local new_coauthor="$2"

    # Remove existing AI Co-authored-by lines
    msg=$(remove_ai_coauthor "$msg")

    # If new_coauthor is empty, just return cleaned message
    if [[ -z "$new_coauthor" ]]; then
        echo "$msg"
        return
    fi

    # Check if message already has any Co-authored-by lines (non-AI)
    local has_coauthor=false
    while IFS= read -r line; do
        if [[ "$line" =~ ^Co-authored-by: ]]; then
            has_coauthor=true
            break
        fi
    done <<< "$msg"

    # Add new Co-authored-by line
    if [[ "$has_coauthor" == "true" ]]; then
        # Add new AI Co-authored-by before existing ones
        local result=""
        local added=false
        while IFS= read -r line; do
            if [[ "$line" =~ ^Co-authored-by: ]] && [[ "$added" == "false" ]]; then
                result="$result$new_coauthor"$'\n'
                added=true
            fi
            if [[ -n "$result" ]]; then
                result="$result"$'\n'
            fi
            result="$result$line"
        done <<< "$msg"
        echo "$result"
    else
        # Add at the end with a blank line separator
        echo "$msg"
        echo ""
        echo "$new_coauthor"
    fi
}

#
# Commit operations
#

apply_ai_authored() {
    local tool_author="${TOOL_EMAILS[$TOOL]}"
    local new_msg
    new_msg=$(update_coauthor "$COMMIT_MSG" "Co-authored-by: $USER_AUTHOR")

    echo "Setting AI tool as author with user as Co-authored-by..."
    git commit --amend --no-edit --author="$tool_author" -m "$new_msg"

    print_green "Done! Commit authored by: $tool_author"
    echo "Co-authored-by: $USER_AUTHOR"
}

apply_ai_assisted() {
    local tool_author="${TOOL_EMAILS[$TOOL]}"
    local new_msg
    new_msg=$(update_coauthor "$COMMIT_MSG" "Co-authored-by: $tool_author")

    echo "Setting user as author with AI tool as Co-authored-by..."
    git commit --amend --no-edit --author="$USER_AUTHOR" -m "$new_msg"

    print_green "Done! Commit authored by: $USER_AUTHOR"
    echo "Co-authored-by: $tool_author"
}

apply_organic() {
    local new_msg
    new_msg=$(remove_ai_coauthor "$COMMIT_MSG")

    echo "Removing AI Co-authored-by and setting user as author..."
    git commit --amend --no-edit --author="$USER_AUTHOR" -m "$new_msg"

    print_green "Done! Commit authored by: $USER_AUTHOR"
    echo "AI Co-authored-by removed."
}

#
# Main
#

main() {
    parse_args "$@"

    require_git_repo
    require_commits

    # Interactive mode selection if not provided
    if [[ -z "$MODE" ]]; then
        prompt_mode
    fi
    validate_mode

    # Interactive tool selection if not provided (skip for organic mode)
    if [[ -z "$TOOL" && "$MODE" != "organic" ]]; then
        prompt_tool
    fi

    # Validate tool (if not organic mode)
    if [[ "$MODE" != "organic" ]]; then
        validate_tool
    fi

    # Get user's configured name and email
    USER_NAME=$(git config user.name) || die "Git user.name must be configured."
    USER_EMAIL=$(git config user.email) || die "Git user.email must be configured."

    if [[ -z "$USER_NAME" || -z "$USER_EMAIL" ]]; then
        die "Git user.name and user.email must be configured."
    fi

    USER_AUTHOR="$USER_NAME <$USER_EMAIL>"
    COMMIT_MSG=$(git log -1 --format=%B)

    # Apply the selected mode
    case "$MODE" in
        ai-authored) apply_ai_authored ;;
        ai-assisted) apply_ai_assisted ;;
        organic)     apply_organic ;;
    esac
}

main "$@"
