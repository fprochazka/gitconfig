#!/usr/bin/env bash

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
source "${SCRIPT_DIR}/lib/common.sh"

#
# Usage
#

usage() {
    cat <<EOF
Usage: git gitlab-clone-all --host=GITLAB_DOMAIN --token=GITLAB_TOKEN --group=GROUP_PATH

Clone all repositories from a GitLab group.

Options:
  --host=GITLAB_DOMAIN     GitLab instance domain (e.g., gitlab.com)
  --token=GITLAB_TOKEN     GitLab personal access token
  --group=GROUP_PATH       Group path to clone repositories from (e.g., my-org/sub-group)
  -h, --help               Show this help message

Examples:
  git gitlab-clone-all --host=gitlab.com --token=glpat-xyz123 --group=my-org
  git gitlab-clone-all --host=gitlab.example.com --token=glpat-xyz123 --group=my-org/sub-group
EOF
    exit 0
}

#
# Argument parsing
#

parse_args() {
    HOST=""
    TOKEN=""
    GROUP=""

    for arg in "$@"; do
        case $arg in
            --host=*)
                HOST="${arg#*=}"
                ;;
            --token=*)
                TOKEN="${arg#*=}"
                ;;
            --group=*)
                GROUP="${arg#*=}"
                ;;
            -h|--help)
                usage
                ;;
            *)
                die "Unknown option: $arg"
                ;;
        esac
    done

    # Validate required parameters
    [[ -z "$HOST" ]] && die "--host is required"
    [[ -z "$TOKEN" ]] && die "--token is required"
    [[ -z "$GROUP" ]] && die "--group is required"

    # Trim whitespace and newlines from GROUP
    GROUP=$(echo -n "$GROUP" | tr -d '\n\r' | sed 's/^[[:space:]]*//;s/[[:space:]]*$//')
}

#
# GitLab API
#

gitlab_api() {
    local endpoint="$1"
    local url="https://${HOST}/api/v4/${endpoint}"

    curl -s -H "PRIVATE-TOKEN: $TOKEN" "$url"
}

url_encode() {
    printf '%s' "$1" | jq -sRr @uri
}

#
# Project discovery
#

get_all_projects() {
    local page=1
    local per_page=100
    local all_projects=""
    local encoded_group
    encoded_group=$(url_encode "$GROUP")

    while true; do
        local endpoint="groups/${encoded_group}/projects?page=${page}&per_page=${per_page}&include_subgroups=true&archived=false"

        echo "Fetching page $page from GitLab API..." >&2
        local projects
        projects=$(gitlab_api "$endpoint")

        # Check if we got any projects
        if [[ $(echo "$projects" | jq '. | length') -eq 0 ]]; then
            break
        fi

        if [[ -z "$all_projects" ]]; then
            all_projects="$projects"
        else
            all_projects=$(echo "$all_projects" "$projects" | jq -s 'add')
        fi

        ((page++))
    done

    echo "$all_projects"
}

verify_group_exists() {
    local encoded_group
    encoded_group=$(url_encode "$GROUP")

    local group_info
    group_info=$(gitlab_api "groups/${encoded_group}?with_projects=false")

    # Check if the group exists by looking for an error or empty response
    if [[ -z "$group_info" ]] || echo "$group_info" | jq -e '.message' >/dev/null 2>&1; then
        if echo "$group_info" | jq -e '.message' >/dev/null 2>&1; then
            die "Group '$GROUP' not found. GitLab API error: $(json_field "$group_info" '.message')"
        fi
        die "Group '$GROUP' not found or not accessible."
    fi

    echo "Group found: $(json_field "$group_info" '.full_name // .name')"
}

#
# Clone operations
#

clone_repo() {
    local ssh_url="$1"
    local path_with_namespace="$2"

    # Create directory structure if it doesn't exist
    local dir_path
    dir_path=$(dirname "$path_with_namespace")
    if [[ "$dir_path" != "." ]]; then
        mkdir -p "$dir_path"
    fi

    if [[ -d "$path_with_namespace" ]]; then
        print_yellow "  Directory already exists, skipping: $path_with_namespace"
        return 0
    fi

    echo "  Cloning: $ssh_url -> $path_with_namespace"
    if git clone "$ssh_url" "$path_with_namespace"; then
        print_green "  Successfully cloned: $path_with_namespace"
    else
        print_red "  Failed to clone: $path_with_namespace"
        return 1
    fi
}

#
# Main
#

main() {
    parse_args "$@"

    echo "GitLab Clone All Repositories"
    echo "Host: $HOST"
    echo "Group: $GROUP"
    echo ""

    echo "Verifying group exists..."
    verify_group_exists
    echo ""

    echo "Fetching repositories from GitLab..."
    local projects
    projects=$(get_all_projects)

    if [[ -z "$projects" ]] || [[ "$projects" == "null" ]] || [[ $(echo "$projects" | jq '. | length') -eq 0 ]]; then
        echo "No repositories found."
        exit 0
    fi

    local project_count
    project_count=$(echo "$projects" | jq '. | length')
    echo "Found $project_count repositories to clone"
    echo ""

    # Process each project
    echo "$projects" | jq -r '.[] | "\(.ssh_url_to_repo)|\(.path_with_namespace)"' | while IFS='|' read -r ssh_url path_with_namespace; do
        clone_repo "$ssh_url" "$path_with_namespace"
    done

    echo ""
    print_green "GitLab clone operation completed!"
}

main "$@"
