#!/usr/bin/env bash
#
# git-mr-status - Show MR/PR status for the current branch
#

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
source "${SCRIPT_DIR}/lib/common.sh"
source "${SCRIPT_DIR}/lib/vcs-hosting.sh"

show_help() {
    cat <<EOF
Usage: git mr-status [BRANCH]

Show MR/PR status for the current branch (works with both GitHub and GitLab).

Arguments:
  BRANCH    Optional branch name (default: current branch)

Options:
  -h, --help    Show this help message
EOF
}

#
# Output formatting
#

print_mr_info() {
    local url="$1"
    local title="$2"
    local branch_display="$3"
    local state="$4"
    local ci_status="$5"
    local body="$6"

    echo "URL:    $url"
    echo "Title:  $title"
    echo "Branch: $branch_display"
    echo "State:  $state"
    echo "CI:     ${ci_status:-n/a}"

    if [[ -n "$body" && "$body" != "null" && "$body" != "" ]]; then
        echo ""
        echo "Description:"
        echo "$body"
    fi
}

#
# GitHub formatting
#

format_github_output() {
    local json="$1"

    local url title body state ci_status
    url=$(json_field "$json" '.url')
    title=$(json_field "$json" '.title')
    body=$(json_field "$json" '.body')
    state=$(json_field "$json" '.state')
    ci_status=$(echo "$json" | jq -r '(.statusCheckRollup // []) | map(.conclusion // .status) | unique | join(", ")' 2>/dev/null || echo "n/a")

    # Format branch display
    local source_branch target_branch is_cross_repo branch_display
    source_branch=$(json_field "$json" '.headRefName')
    target_branch=$(json_field "$json" '.baseRefName')
    is_cross_repo=$(json_field "$json" '.isCrossRepository')

    if [[ "$is_cross_repo" == "true" ]]; then
        local head_owner base_owner
        head_owner=$(json_field "$json" '.headRepositoryOwner.login')
        base_owner=$(echo "$url" | sed -E 's|https://github.com/([^/]+)/.*|\1|')
        branch_display="${head_owner}:${source_branch} → ${base_owner}:${target_branch}"
    else
        branch_display="$source_branch → $target_branch"
    fi

    print_mr_info "$url" "$title" "$branch_display" "$state" "$ci_status" "$body"
}

#
# GitLab formatting
#

format_gitlab_output() {
    local json="$1"

    local url title body state ci_status
    url=$(json_field "$json" '.web_url')
    title=$(json_field "$json" '.title')
    body=$(json_field "$json" '.description')
    state=$(json_field "$json" '.state')
    ci_status=$(json_field "$json" '.pipeline.status // "n/a"')

    # Format branch display
    local source_branch target_branch source_project_id target_project_id branch_display
    source_branch=$(json_field "$json" '.source_branch')
    target_branch=$(json_field "$json" '.target_branch')
    source_project_id=$(json_field "$json" '.source_project_id')
    target_project_id=$(json_field "$json" '.target_project_id')

    if [[ "$source_project_id" != "$target_project_id" ]]; then
        local source_project target_project
        source_project=$(glab api "projects/$source_project_id" 2>/dev/null | jq -r '.path_with_namespace')
        target_project=$(glab api "projects/$target_project_id" 2>/dev/null | jq -r '.path_with_namespace')
        branch_display="${source_project}:${source_branch} → ${target_project}:${target_branch}"
    else
        branch_display="$source_branch → $target_branch"
    fi

    print_mr_info "$url" "$title" "$branch_display" "$state" "$ci_status" "$body"
}

#
# Main
#

main() {
    if [[ "${1:-}" == "-h" ]] || [[ "${1:-}" == "--help" ]]; then
        show_help
        exit 0
    fi

    require_git_repo

    local current_branch
    current_branch=$(git branch --show-current)

    local explicit_branch="${1:-}"
    local host
    host=$(vcs_get_host)

    local json
    if ! json=$(vcs_mr_view "$explicit_branch" 2>&1); then
        echo "No merge request found for branch '${explicit_branch:-$current_branch}'"
        exit 0
    fi

    case "$host" in
        github)
            format_github_output "$json"
            ;;
        gitlab)
            format_gitlab_output "$json"
            ;;
    esac
}

main "$@"
